cache: false
language: python
services:
- docker
env:
  global:
  - BUILD_DIR=builds
  - DOCKERHUB_REPOSITORY=todo
  matrix:
  - NAME=python_3.7    SRC_IMAGE=python:3.7-stretch    SRC_PYTHON_EXE=python
  - NAME=python_3.6    SRC_IMAGE=python:3.6-stretch    SRC_PYTHON_EXE=python
  - NAME=python_3.5    SRC_IMAGE=python:3.5            SRC_PYTHON_EXE=python
  - NAME=python_2.7    SRC_IMAGE=python:2.7-stretch    SRC_PYTHON_EXE=python
  - NAME=pypy_3        SRC_IMAGE=pypy:3                SRC_PYTHON_EXE=pypy3
  - NAME=pypy_2        SRC_IMAGE=pypy:2                SRC_PYTHON_EXE=pypy
  - NAME=anaconda_3    SRC_IMAGE=continuumio/anaconda3 SRC_PYTHON_EXE=python
  - NAME=anaconda_2    SRC_IMAGE=continuumio/anaconda  SRC_PYTHON_EXE=python
install:
- sudo apt-get install -y sshpass
script:
#- echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
- TAG_LOCAL=${DOCKERHUB_REPOSITORY}:${NAME}
- mkdir ${BUILD_DIR}
- python create_linux_dockerfile.py ${SRC_IMAGE} ${SRC_PYTHON_EXE} ${BUILD_DIR}/${NAME}
- while sleep 9m; do echo "still running..."; done &
- docker build --compress --no-cache -t ${TAG_LOCAL} ${BUILD_DIR}/${NAME}
- docker run ${TAG_LOCAL} /bin/sh -c "sleep 0"
- ID=`docker ps -l -q`
- docker cp ${ID}:/root/dynamic_vars.out .
- docker run ${TAG_LOCAL} rm /root/dynamic_vars.out
- |
  while read p
  do
     docker run ${TAG_LOCAL} /bin/sh -c "sleep 0"
     # get the id of the last container that was run
     ID=`docker ps -l -q`
     docker commit --change "ENV ${p}" ${ID} ${TAG_LOCAL}
  done < dynamic_vars.out
#- docker tag ${TAG_LOCAL} ${DOCKERHUB_USERNAME}/${TAG_LOCAL}
#- travis_retry docker push ${DOCKERHUB_USERNAME}/${TAG_LOCAL}
